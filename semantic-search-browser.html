<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>AI è¯­ä¹‰æœç´¢æ¼”ç¤º - çº¯æµè§ˆå™¨ç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 48px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .header .subtitle {
      font-size: 20px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .badges {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #333;
    }

    .status-section {
      margin-bottom: 20px;
    }

    .status-indicator {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator.loading {
      background: #fff3cd;
      color: #856404;
    }

    .status-indicator.success {
      background: #d4edda;
      color: #155724;
    }

    .status-indicator.error {
      background: #f8d7da;
      color: #721c24;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      width: 0%;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .stat-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #667eea;
    }

    .search-section {
      margin-bottom: 20px;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-btn {
      padding: 12px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    .search-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .results-section {
      max-height: 500px;
      overflow-y: auto;
    }

    .result-item {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .result-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .result-title {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .result-similarity {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
    }

    .result-content {
      color: #555;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .result-meta {
      font-size: 12px;
      color: #6c757d;
    }

    .log-section {
      height: 400px;
      overflow-y: auto;
    }

    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      font-family: "Consolas", "Monaco", monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 100%;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 4px;
      padding: 4px 0;
    }

    .log-entry.info {
      color: #4fc3f7;
    }

    .log-entry.success {
      color: #66bb6a;
    }

    .log-entry.error {
      color: #ef5350;
    }

    .log-entry.warning {
      color: #ffb74d;
    }

    .log-time {
      color: #888;
      margin-right: 8px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #764ba2;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-left-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>
        <span style="font-size: 64px">ğŸš€</span>
        AI è¯­ä¹‰æœç´¢æ¼”ç¤º
      </h1>
      <div class="subtitle">çº¯æµè§ˆå™¨ç‰ˆ + WASM é«˜æ€§èƒ½ç‰ˆæœ¬</div>
      <div class="badges">
        <div class="badge">
          <span>âš¡</span>
          <span>WASM åŠ é€Ÿ</span>
        </div>
        <div class="badge">
          <span>ğŸ¯</span>
          <span id="currentModel">æœªé€‰æ‹©æ¨¡å‹</span>
        </div>
        <div class="badge">
          <span>ğŸ“š</span>
          <span>100+ è¯­è¨€æ”¯æŒ</span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="card">
        <div class="card-title">
          <span>ğŸ“Š</span>
          <span>ç³»ç»ŸçŠ¶æ€</span>
        </div>

        <div class="status-section">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
              é€‰æ‹©æ¨¡å‹ï¼š
            </label>
            <select id="modelSelect"
              style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; cursor: pointer;">
              <option value="small" selected>multilingual-e5-small (116MB, 384ç»´, é€Ÿåº¦å¿«)</option>
              <option value="base">multilingual-e5-base (279MB, 768ç»´, ç²¾åº¦é«˜)</option>
            </select>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
              ç›¸ä¼¼åº¦é˜ˆå€¼ï¼š<span id="thresholdValue">50%</span>
            </label>
            <input type="range" id="thresholdSlider" min="0" max="100" value="50" style="width: 100%; cursor: pointer;"
              oninput="document.getElementById('thresholdValue').textContent = this.value + '%'">
            <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
              åªæ˜¾ç¤ºç›¸ä¼¼åº¦é«˜äºæ­¤å€¼çš„ç»“æœ
            </div>
          </div>

          <button id="initBtn"
            style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 16px;">
            åˆå§‹åŒ–æœç´¢å¼•æ“
          </button>

          <div id="status" class="status-indicator loading" style="display: none;">
            <div class="loading-spinner"></div>
            <span>ç­‰å¾…åˆå§‹åŒ–...</span>
          </div>
          <div class="progress-bar" style="display: none;">
            <div id="progress" class="progress-fill"></div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">å·²ç´¢å¼•æ–‡æ¡£</div>
            <div id="docCount" class="stat-value">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">æ–‡æœ¬å—æ•°é‡</div>
            <div id="chunkCount" class="stat-value">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">å‘é‡ç»´åº¦</div>
            <div id="dimension" class="stat-value">-</div>
          </div>
        </div>

        <div class="search-section" style="margin-top: 24px">
          <div class="card-title">
            <span>ğŸ”</span>
            <span>è¯­ä¹‰æœç´¢</span>
          </div>
          <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="è¾“å…¥æœç´¢å†…å®¹... (ä¾‹å¦‚: æœºå™¨å­¦ä¹ )" value="æœºå™¨å­¦ä¹ " />
            <button id="searchBtn" class="search-btn" disabled>æœç´¢</button>
          </div>
          <div id="results" class="results-section"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>ğŸ“</span>
          <span>è¿è¡Œæ—¥å¿—</span>
        </div>
        <div class="log-section">
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ==================== å¯¼å…¥ä¾èµ– ====================
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';
    // ä½¿ç”¨æœ¬åœ°çš„ hnswlibï¼ˆä» node_modules åŠ è½½ï¼‰
    import { loadHnswlib } from './node_modules/hnswlib-wasm-static/dist/hnswlib.js';

    const log = [];

    // ==================== å·¥å…·å‡½æ•° ====================
    function addLog(message, type = "info") {
      const time = new Date().toLocaleTimeString();
      const logDiv = document.getElementById("log");
      const entry = document.createElement("div");
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      log.push({ time, message, type });
      console.log(`[${time}] ${message}`);
    }

    function updateStatus(message, type = "loading") {
      const statusDiv = document.getElementById("status");
      statusDiv.style.display = 'flex';
      statusDiv.className = `status-indicator ${type}`;

      let icon = '<div class="loading-spinner"></div>';
      if (type === "success") icon = '<span>âœ“</span>';
      if (type === "error") icon = '<span>âœ—</span>';

      statusDiv.innerHTML = `${icon}<span>${message}</span>`;
    }

    function updateProgress(percent) {
      const progressBar = document.querySelector(".progress-bar");
      const progressFill = document.getElementById("progress");
      progressBar.style.display = 'block';
      progressFill.style.width = `${percent}%`;
    }

    function updateStats() {
      document.getElementById("docCount").textContent = indexer?.documents?.size || 0;
      document.getElementById("chunkCount").textContent = indexer?.vectorDatabase?.docCount || 0;
    }

    function displayResults(results) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (results.length === 0) {
        resultsDiv.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 40px;">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</div>';
        return;
      }

      results.forEach((result, index) => {
        const item = document.createElement("div");
        item.className = "result-item";

        // æ ¹æ®ç›¸ä¼¼åº¦è®¾ç½®è¾¹æ¡†é¢œè‰²
        let borderColor = '#667eea'; // é»˜è®¤è“è‰²
        if (result.similarity > 0.8) borderColor = '#66bb6a'; // é«˜ç›¸ä¼¼åº¦ç»¿è‰²
        else if (result.similarity < 0.6) borderColor = '#ffb74d'; // ä½ç›¸ä¼¼åº¦æ©™è‰²

        item.style.borderLeftColor = borderColor;

        item.innerHTML = `
          <div class="result-header">
            <div class="result-title">${result.title || 'æœªå‘½åæ–‡æ¡£'}</div>
            <div class="result-similarity" style="background: ${borderColor};">${(result.similarity * 100).toFixed(1)}%</div>
          </div>
          <div class="result-content">${result.text}</div>
          <div class="result-meta">
            æ¥æº: ${result.url || result.pageId} | 
            ä½ç½®: ${result.startIdx}-${result.endIdx} |
            è·ç¦»: ${result.distance?.toFixed(4) || 'N/A'}
          </div>
        `;
        resultsDiv.appendChild(item);
      });
    }

    // ==================== TextChunker ====================
    class TextChunker {
      constructor(options = {}) {
        this.chunkSize = options.chunkSize || 500;
        this.overlap = options.overlap || 50;
        this.minChunkSize = options.minChunkSize || 100;
      }

      chunkText(content, title = '') {
        if (!content || content.trim().length === 0) {
          return [];
        }

        const cleanContent = content.replace(/\s+/g, ' ').trim();
        const sentences = this.splitIntoSentences(cleanContent);
        const chunks = [];
        let currentChunk = [];
        let currentLength = 0;

        for (const sentence of sentences) {
          const sentenceLength = sentence.length;

          if (currentLength + sentenceLength > this.chunkSize && currentChunk.length > 0) {
            const chunkText = currentChunk.join(' ');
            if (chunkText.length >= this.minChunkSize) {
              chunks.push({
                text: chunkText,
                startIdx: chunks.length > 0 ? chunks[chunks.length - 1].endIdx - this.overlap : 0,
                endIdx: chunks.length > 0 ? chunks[chunks.length - 1].endIdx + chunkText.length - this.overlap : chunkText.length,
                title,
              });
            }

            const overlapSentences = currentChunk.slice(-Math.ceil(this.overlap / 100));
            currentChunk = overlapSentences;
            currentLength = overlapSentences.reduce((sum, s) => sum + s.length, 0);
          }

          currentChunk.push(sentence);
          currentLength += sentenceLength;
        }

        if (currentChunk.length > 0) {
          const chunkText = currentChunk.join(' ');
          if (chunkText.length >= this.minChunkSize) {
            chunks.push({
              text: chunkText,
              startIdx: chunks.length > 0 ? chunks[chunks.length - 1].endIdx - this.overlap : 0,
              endIdx: chunks.length > 0 ? chunks[chunks.length - 1].endIdx + chunkText.length - this.overlap : chunkText.length,
              title,
            });
          }
        }

        return chunks;
      }

      splitIntoSentences(content) {
        const sentenceEndings = /([.!?;ã€‚ï¼ï¼Ÿï¼›]+[\s\n]*)/g;
        const parts = content.split(sentenceEndings);
        const sentences = [];

        for (let i = 0; i < parts.length; i += 2) {
          const text = parts[i];
          const ending = parts[i + 1] || '';
          if (text.trim()) {
            sentences.push((text + ending).trim());
          }
        }

        return sentences.length > 0 ? sentences : [content];
      }
    }

    // ==================== SemanticEngine ====================
    class SemanticEngine {
      constructor(config = {}) {
        this.modelName = config.modelName || 'Xenova/multilingual-e5-small';
        // æ ¹æ®æ¨¡å‹è‡ªåŠ¨è®¾ç½®ç»´åº¦
        const defaultDimension = this.modelName.includes('base') ? 768 : 384;
        this.dimension = config.dimension || defaultDimension;
        this.useQuantized = config.useQuantized !== false;

        this.pipe = null;
        this.isInitialized = false;

        // é…ç½® transformers.js ç¯å¢ƒ
        env.allowLocalModels = false;
        env.useBrowserCache = true;
        env.allowRemoteModels = true;

        addLog('SemanticEngine é…ç½®å®Œæˆ', 'info');
      }

      async initialize() {
        if (this.isInitialized) return;

        try {
          addLog(`æ­£åœ¨åŠ è½½æ¨¡å‹: ${this.modelName}...`, 'info');
          addLog('æç¤º: é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹ (çº¦ 116MB)ï¼Œè¯·ç¨å€™', 'warning');

          const startTime = Date.now();

          this.pipe = await pipeline('feature-extraction', this.modelName, {
            quantized: this.useQuantized,
          });

          const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
          addLog(`âœ“ æ¨¡å‹åŠ è½½å®Œæˆ (è€—æ—¶: ${elapsed}ç§’)`, 'success');

          this.isInitialized = true;
        } catch (error) {
          addLog(`âœ— æ¨¡å‹åŠ è½½å¤±è´¥: ${error.message}`, 'error');
          throw error;
        }
      }

      async getEmbedding(text) {
        if (!this.isInitialized) {
          await this.initialize();
        }

        try {
          const output = await this.pipe(text, { pooling: 'mean', normalize: true });
          const embedding = Array.from(output.data);

          // è°ƒè¯•ï¼šæ˜¾ç¤ºç”Ÿæˆçš„å‘é‡ä¿¡æ¯
          console.log('ç”Ÿæˆ embedding:', {
            æ–‡æœ¬é•¿åº¦: text.length,
            æ–‡æœ¬é¢„è§ˆ: text.substring(0, 50) + '...',
            å‘é‡ç»´åº¦: embedding.length,
            å‘é‡å‰5ä¸ªå€¼: embedding.slice(0, 5),
            å‘é‡èŒƒå›´: [Math.min(...embedding), Math.max(...embedding)]
          });

          return embedding;
        } catch (error) {
          console.error('ç”Ÿæˆå‘é‡å¤±è´¥:', error);
          throw error;
        }
      }

      async getEmbeddingsBatch(texts) {
        if (!this.isInitialized) {
          await this.initialize();
        }

        const embeddings = [];
        for (const text of texts) {
          const embedding = await this.getEmbedding(text);
          embeddings.push(embedding);
        }
        return embeddings;
      }
    }

    // ==================== VectorDatabase ====================
    class VectorDatabase {
      constructor(config = {}) {
        this.dimension = config.dimension || 768;
        this.maxElements = config.maxElements || 10000;
        this.M = config.M || 16;
        this.efConstruction = config.efConstruction || 200;
        this.efSearch = config.efSearch || 50;

        this.hnswlib = null;
        this.index = null;
        this.documents = new Map();
        this.docCount = 0;
        this.isInitialized = false;
      }

      async initialize() {
        if (this.isInitialized) return;

        try {
          addLog('æ­£åœ¨åˆå§‹åŒ–å‘é‡æ•°æ®åº“ï¼ˆWASM é«˜æ€§èƒ½ç‰ˆï¼‰...', 'info');

          this.hnswlib = await loadHnswlib();
          addLog('âœ“ WASM æ¨¡å—åŠ è½½å®Œæˆ', 'success');

          this.index = new this.hnswlib.HierarchicalNSW('cosine', this.dimension, 'vector_index.bin');
          this.index.initIndex(this.maxElements, this.M, this.efConstruction, 200);
          this.index.setEfSearch(this.efSearch);

          addLog('âœ“ å‘é‡æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ', 'success');
          this.isInitialized = true;
        } catch (error) {
          addLog(`âœ— å‘é‡æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          throw error;
        }
      }

      async addDocument(pageId, url, title, chunk, embedding) {
        if (!this.isInitialized) {
          await this.initialize();
        }

        try {
          const docId = this.docCount;

          // ç¡®ä¿ embedding æ˜¯æ™®é€šæ•°ç»„
          const cleanEmbedding = Array.isArray(embedding)
            ? embedding
            : Array.from(embedding);

          // åˆ›å»º VectorFloat å¯¹è±¡ï¼ˆhnswlib-wasm-static è¦æ±‚ï¼‰
          let vectorToAdd;
          try {
            if (this.hnswlib && this.hnswlib.VectorFloat) {
              vectorToAdd = new this.hnswlib.VectorFloat();
              for (let i = 0; i < cleanEmbedding.length; i++) {
                vectorToAdd.push_back(cleanEmbedding[i]);
              }
            } else {
              vectorToAdd = cleanEmbedding;
            }

            // addPoint(vector, label, replaceDeleted)
            this.index.addPoint(vectorToAdd, docId, false);

            // æ¸…ç† VectorFloat å¯¹è±¡
            if (vectorToAdd && typeof vectorToAdd.delete === 'function') {
              vectorToAdd.delete();
            }
          } catch (vectorError) {
            console.error('VectorFloat æ–¹å¼å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ:', vectorError);
            this.index.addPoint(cleanEmbedding, docId, false);
          }

          this.documents.set(docId, {
            pageId,
            url,
            title,
            text: chunk.text,
            startIdx: chunk.startIdx,
            endIdx: chunk.endIdx,
          });

          this.docCount++;
        } catch (error) {
          console.error('æ·»åŠ æ–‡æ¡£å¤±è´¥:', error);
          throw error;
        }
      }

      async search(queryEmbedding, topK = 10) {
        if (!this.isInitialized) {
          throw new Error('å‘é‡æ•°æ®åº“æœªåˆå§‹åŒ–');
        }

        if (this.docCount === 0) {
          return [];
        }

        try {
          // ç¡®ä¿ queryEmbedding æ˜¯æ™®é€šæ•°ç»„
          const cleanQuery = Array.isArray(queryEmbedding)
            ? queryEmbedding
            : Array.from(queryEmbedding);

          // åˆ›å»º VectorFloat å¯¹è±¡ï¼ˆhnswlib-wasm-static è¦æ±‚ï¼‰
          let vectorQuery;
          try {
            if (this.hnswlib && this.hnswlib.VectorFloat) {
              vectorQuery = new this.hnswlib.VectorFloat();
              for (let i = 0; i < cleanQuery.length; i++) {
                vectorQuery.push_back(cleanQuery[i]);
              }
            } else {
              vectorQuery = cleanQuery;
            }

            const result = this.index.searchKnn(vectorQuery, Math.min(topK, this.docCount), undefined);

            // æ¸…ç† VectorFloat å¯¹è±¡
            if (vectorQuery && typeof vectorQuery.delete === 'function') {
              vectorQuery.delete();
            }

            const results = [];
            for (let i = 0; i < result.neighbors.length; i++) {
              const docId = result.neighbors[i];
              const distance = result.distances[i];
              const similarity = 1 - distance;

              const doc = this.documents.get(docId);
              if (doc) {
                results.push({
                  ...doc,
                  similarity,
                  distance,
                });
              }
            }

            return results.sort((a, b) => b.similarity - a.similarity);
          } catch (vectorError) {
            console.error('VectorFloat æœç´¢å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ:', vectorError);
            const result = this.index.searchKnn(cleanQuery, Math.min(topK, this.docCount), undefined);

            const results = [];
            for (let i = 0; i < result.neighbors.length; i++) {
              const docId = result.neighbors[i];
              const distance = result.distances[i];
              const similarity = 1 - distance;

              const doc = this.documents.get(docId);
              if (doc) {
                results.push({
                  ...doc,
                  similarity,
                  distance,
                });
              }
            }

            return results.sort((a, b) => b.similarity - a.similarity);
          }
        } catch (error) {
          console.error('æœç´¢å¤±è´¥:', error);
          throw error;
        }
      }
    }

    // ==================== ContentIndexer ====================
    class ContentIndexer {
      constructor(config = {}) {
        this.textChunker = new TextChunker({
          chunkSize: config.chunkSize || 500,
          overlap: config.overlap || 50,
        });

        this.semanticEngine = new SemanticEngine({
          modelName: config.modelName || 'Xenova/multilingual-e5-small',
          dimension: config.dimension || 384,
        });

        this.vectorDatabase = new VectorDatabase({
          dimension: config.dimension || 768,  // é»˜è®¤ä½¿ç”¨ base æ¨¡å‹çš„ç»´åº¦
        });

        this.documents = new Map();
        this.isInitialized = false;
      }

      async initialize() {
        if (this.isInitialized) return;

        try {
          addLog('å¼€å§‹åˆå§‹åŒ–å†…å®¹ç´¢å¼•å™¨...', 'info');
          updateProgress(10);

          await Promise.all([
            this.semanticEngine.initialize(),
            this.vectorDatabase.initialize(),
          ]);

          updateProgress(50);
          addLog('âœ“ å†…å®¹ç´¢å¼•å™¨åˆå§‹åŒ–å®Œæˆ', 'success');
          this.isInitialized = true;
        } catch (error) {
          addLog(`âœ— å†…å®¹ç´¢å¼•å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          throw error;
        }
      }

      async indexDocument(pageId, url, title, content) {
        if (!this.isInitialized) {
          await this.initialize();
        }

        try {
          const chunks = this.textChunker.chunkText(content, title);
          addLog(`æ–‡æ¡£ "${title}" åˆ†å—å®Œæˆ: ${chunks.length} ä¸ªå—`, 'info');

          for (let i = 0; i < chunks.length; i++) {
            const chunk = chunks[i];
            const embedding = await this.semanticEngine.getEmbedding(chunk.text);
            await this.vectorDatabase.addDocument(pageId, url, title, chunk, embedding);

            if ((i + 1) % 5 === 0) {
              updateProgress(50 + (i + 1) / chunks.length * 40);
            }
          }

          this.documents.set(pageId, { url, title, chunkCount: chunks.length });
          addLog(`âœ“ æ–‡æ¡£ "${title}" ç´¢å¼•å®Œæˆ`, 'success');
        } catch (error) {
          addLog(`âœ— æ–‡æ¡£ç´¢å¼•å¤±è´¥: ${error.message}`, 'error');
          throw error;
        }
      }

      async search(query, topK = 10) {
        if (!this.isInitialized) {
          throw new Error('å†…å®¹ç´¢å¼•å™¨æœªåˆå§‹åŒ–');
        }

        try {
          addLog(`å¼€å§‹æœç´¢: "${query.substring(0, 50)}..."`, 'info');
          console.log('=== å¼€å§‹æœç´¢ ===');
          console.log('æŸ¥è¯¢æ–‡æœ¬:', query);

          const queryEmbedding = await this.semanticEngine.getEmbedding(query);
          console.log('æŸ¥è¯¢å‘é‡:', queryEmbedding.slice(0, 5), '...');

          const results = await this.vectorDatabase.search(queryEmbedding, topK);

          console.log('æœç´¢ç»“æœ:', results.map(r => ({
            æ ‡é¢˜: r.title,
            ç›¸ä¼¼åº¦: (r.similarity * 100).toFixed(2) + '%',
            è·ç¦»: r.distance,
            æ–‡æœ¬é¢„è§ˆ: r.text.substring(0, 50) + '...'
          })));

          addLog(`âœ“ æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${results.length} ä¸ªç»“æœ`, 'success');
          return results;
        } catch (error) {
          addLog(`âœ— æœç´¢å¤±è´¥: ${error.message}`, 'error');
          throw error;
        }
      }
    }

    // ==================== éªŒè¯æµ‹è¯• ====================
    async function runValidationTests() {
      try {
        addLog("æµ‹è¯• 1: æœç´¢ 'æœºå™¨å­¦ä¹ 'ï¼ˆåº”è¯¥åŒ¹é… AI æ–‡æ¡£ï¼‰", "info");
        const test1 = await indexer.search("æœºå™¨å­¦ä¹ ", 3);
        addLog(`  ç»“æœ: ${test1[0].title}, ç›¸ä¼¼åº¦: ${(test1[0].similarity * 100).toFixed(2)}%`,
          test1[0].title.includes("äººå·¥æ™ºèƒ½") && test1[0].similarity > 0.6 ? "success" : "error");

        addLog("æµ‹è¯• 2: æœç´¢ 'React Vue'ï¼ˆåº”è¯¥åŒ¹é… Web æ–‡æ¡£ï¼‰", "info");
        const test2 = await indexer.search("React Vue", 3);
        addLog(`  ç»“æœ: ${test2[0].title}, ç›¸ä¼¼åº¦: ${(test2[0].similarity * 100).toFixed(2)}%`,
          test2[0].title.includes("Web") && test2[0].similarity > 0.6 ? "success" : "error");

        addLog("æµ‹è¯• 3: æœç´¢ 'ç»Ÿè®¡å­¦'ï¼ˆåº”è¯¥åŒ¹é…æ•°æ®ç§‘å­¦æ–‡æ¡£ï¼‰", "info");
        const test3 = await indexer.search("ç»Ÿè®¡å­¦", 3);
        addLog(`  ç»“æœ: ${test3[0].title}, ç›¸ä¼¼åº¦: ${(test3[0].similarity * 100).toFixed(2)}%`,
          test3[0].title.includes("æ•°æ®") && test3[0].similarity > 0.6 ? "success" : "error");

        addLog("âœ“ éªŒè¯æµ‹è¯•å®Œæˆï¼è¯­ä¹‰æœç´¢æ­£å¸¸å·¥ä½œ", "success");
      } catch (error) {
        addLog(`éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
      }
    }

    // ==================== ä¸»ç¨‹åº ====================
    let indexer = null;

    // åˆå§‹åŒ–
    async function initialize() {
      try {
        const modelSelect = document.getElementById("modelSelect");
        const selectedModel = modelSelect.value;

        const modelConfig = {
          small: {
            name: "Xenova/multilingual-e5-small",
            dimension: 384,
            displayName: "multilingual-e5-small"
          },
          base: {
            name: "Xenova/multilingual-e5-base",
            dimension: 768,
            displayName: "multilingual-e5-base"
          }
        };

        const config = modelConfig[selectedModel];

        addLog(`å¼€å§‹åˆå§‹åŒ–è¯­ä¹‰æœç´¢å¼•æ“ï¼ˆä½¿ç”¨ ${config.displayName}ï¼‰...`, "info");
        updateStatus("æ­£åœ¨åˆå§‹åŒ–...", "loading");

        // æ›´æ–°æ˜¾ç¤º
        document.getElementById("currentModel").textContent = config.displayName;
        document.getElementById("dimension").textContent = config.dimension;

        indexer = new ContentIndexer({
          modelName: config.name,
          dimension: config.dimension,
        });

        await indexer.initialize();
        updateProgress(60);

        // ç´¢å¼•ç¤ºä¾‹æ–‡æ¡£
        addLog("å¼€å§‹ç´¢å¼•ç¤ºä¾‹æ–‡æ¡£...", "info");

        const sampleDocs = [
          {
            id: "doc1",
            url: "https://example.com/ai",
            title: "äººå·¥æ™ºèƒ½ç®€ä»‹",
            content: "äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligence, AIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äºåˆ›å»ºèƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„ç³»ç»Ÿã€‚æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œå®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿä»æ•°æ®ä¸­å­¦ä¹ è€Œæ— éœ€æ˜ç¡®ç¼–ç¨‹ã€‚æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥å¤„ç†å¤æ‚çš„æ¨¡å¼è¯†åˆ«ä»»åŠ¡ã€‚",
          },
          {
            id: "doc2",
            url: "https://example.com/web",
            title: "Web å¼€å‘æŠ€æœ¯",
            content: "Web å¼€å‘æ¶‰åŠåˆ›å»ºç½‘ç«™å’Œ Web åº”ç”¨ç¨‹åºã€‚å‰ç«¯å¼€å‘ä¸»è¦ä½¿ç”¨ HTMLã€CSS å’Œ JavaScript æ„å»ºç”¨æˆ·ç•Œé¢ã€‚åç«¯å¼€å‘å¤„ç†æœåŠ¡å™¨ç«¯é€»è¾‘ã€æ•°æ®åº“å’Œ APIã€‚ç°ä»£ Web å¼€å‘æ¡†æ¶å¦‚ Reactã€Vue å’Œ Angular ä½¿æ„å»ºå¤æ‚çš„ç”¨æˆ·ç•Œé¢å˜å¾—æ›´å®¹æ˜“ã€‚",
          },
          {
            id: "doc3",
            url: "https://example.com/data",
            title: "æ•°æ®ç§‘å­¦åŸºç¡€",
            content: "æ•°æ®ç§‘å­¦æ˜¯ä¸€ä¸ªè·¨å­¦ç§‘é¢†åŸŸï¼Œä½¿ç”¨ç§‘å­¦æ–¹æ³•ã€æµç¨‹ã€ç®—æ³•å’Œç³»ç»Ÿä»æ•°æ®ä¸­æå–çŸ¥è¯†å’Œæ´å¯Ÿã€‚å®ƒç»“åˆäº†ç»Ÿè®¡å­¦ã€æ•°æ®åˆ†æã€æœºå™¨å­¦ä¹ å’Œç›¸å…³æ–¹æ³•æ¥ç†è§£å’Œåˆ†æå®é™…ç°è±¡ã€‚æ•°æ®å¯è§†åŒ–æ˜¯æ•°æ®ç§‘å­¦çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå¸®åŠ©äººä»¬ç†è§£å¤æ‚çš„æ•°æ®æ¨¡å¼ã€‚",
          }, {
            id: "doc4",
            url: "https://example.com/blockchain",
            title: "åŒºå—é“¾æŠ€æœ¯",
            content: "åŒºå—é“¾æ˜¯ä¸€ç§åˆ†å¸ƒå¼è´¦æœ¬æŠ€æœ¯ï¼Œé€šè¿‡åŠ å¯†ç®—æ³•å’Œå…±è¯†æœºåˆ¶ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œä¸å¯ç¯¡æ”¹æ€§ã€‚æ¯”ç‰¹å¸æ˜¯ç¬¬ä¸€ä¸ªæˆåŠŸçš„åŒºå—é“¾åº”ç”¨ï¼Œè€Œä»¥å¤ªåŠå¼•å…¥äº†æ™ºèƒ½åˆçº¦åŠŸèƒ½ã€‚åŒºå—é“¾æŠ€æœ¯åœ¨é‡‘èã€ä¾›åº”é“¾ç®¡ç†ã€æ•°å­—èº«ä»½éªŒè¯ç­‰é¢†åŸŸæœ‰å¹¿æ³›åº”ç”¨ã€‚å»ä¸­å¿ƒåŒ–æ˜¯åŒºå—é“¾çš„æ ¸å¿ƒç‰¹å¾ä¹‹ä¸€ã€‚",
          },
          {
            id: "doc5",
            url: "https://example.com/mobile",
            title: "ç§»åŠ¨åº”ç”¨å¼€å‘",
            content: "ç§»åŠ¨åº”ç”¨å¼€å‘åŒ…æ‹¬ä¸º iOS å’Œ Android å¹³å°åˆ›å»ºåº”ç”¨ç¨‹åºã€‚åŸç”Ÿå¼€å‘ä½¿ç”¨ Swiftï¼ˆiOSï¼‰å’Œ Kotlinï¼ˆAndroidï¼‰ï¼Œæä¾›æœ€ä½³æ€§èƒ½ã€‚è·¨å¹³å°æ¡†æ¶å¦‚ React Native å’Œ Flutter å…è®¸ä½¿ç”¨å•ä¸€ä»£ç åº“å¼€å‘å¤šå¹³å°åº”ç”¨ã€‚ç§»åŠ¨åº”ç”¨éœ€è¦è€ƒè™‘è§¦æ‘¸äº¤äº’ã€ç”µæ± ä¼˜åŒ–å’Œä¸åŒå±å¹•å°ºå¯¸çš„é€‚é…ã€‚",
          },
          {
            id: "doc6",
            url: "https://example.com/cloud",
            title: "äº‘è®¡ç®—æœåŠ¡",
            content: "äº‘è®¡ç®—æä¾›æŒ‰éœ€è®¿é—®çš„è®¡ç®—èµ„æºï¼ŒåŒ…æ‹¬æœåŠ¡å™¨ã€å­˜å‚¨ã€æ•°æ®åº“å’Œç½‘ç»œã€‚ä¸»è¦çš„äº‘æœåŠ¡æä¾›å•†åŒ…æ‹¬ AWSã€Azure å’Œ Google Cloudã€‚äº‘è®¡ç®—æ¨¡å¼åŒ…æ‹¬ IaaSï¼ˆåŸºç¡€è®¾æ–½å³æœåŠ¡ï¼‰ã€PaaSï¼ˆå¹³å°å³æœåŠ¡ï¼‰å’Œ SaaSï¼ˆè½¯ä»¶å³æœåŠ¡ï¼‰ã€‚äº‘è®¡ç®—å…·æœ‰å¼¹æ€§æ‰©å±•ã€æˆæœ¬æ•ˆç›Šå’Œå…¨çƒå¯ç”¨æ€§ç­‰ä¼˜åŠ¿ã€‚",
          },
          {
            id: "doc7",
            url: "https://example.com/security",
            title: "ç½‘ç»œå®‰å…¨é˜²æŠ¤",
            content: "ç½‘ç»œå®‰å…¨æ¶‰åŠä¿æŠ¤è®¡ç®—æœºç³»ç»Ÿå’Œç½‘ç»œå…å—æ•°å­—æ”»å‡»ã€‚å¸¸è§çš„å®‰å…¨å¨èƒåŒ…æ‹¬æ¶æ„è½¯ä»¶ã€é’“é±¼æ”»å‡»ã€DDoS æ”»å‡»å’Œ SQL æ³¨å…¥ã€‚å®‰å…¨æªæ–½åŒ…æ‹¬é˜²ç«å¢™ã€åŠ å¯†ã€èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶ã€‚å®šæœŸæ›´æ–°è½¯ä»¶ã€ä½¿ç”¨å¼ºå¯†ç å’Œå‘˜å·¥å®‰å…¨åŸ¹è®­æ˜¯ä¿æŠ¤ç³»ç»Ÿçš„é‡è¦æ­¥éª¤ã€‚æ¸—é€æµ‹è¯•å¯ä»¥å¸®åŠ©å‘ç°ç³»ç»Ÿæ¼æ´ã€‚",
          },
          {
            id: "doc8",
            url: "https://example.com/database",
            title: "æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ",
            content: "æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰ç”¨äºå­˜å‚¨ã€ç®¡ç†å’Œæ£€ç´¢æ•°æ®ã€‚å…³ç³»å‹æ•°æ®åº“å¦‚ MySQLã€PostgreSQL ä½¿ç”¨ SQL æŸ¥è¯¢è¯­è¨€å’Œè¡¨æ ¼ç»“æ„ã€‚NoSQL æ•°æ®åº“å¦‚ MongoDBã€Redis æä¾›æ›´çµæ´»çš„æ•°æ®æ¨¡å‹ï¼Œé€‚åˆå¤§è§„æ¨¡å’Œéç»“æ„åŒ–æ•°æ®ã€‚æ•°æ®åº“è®¾è®¡éœ€è¦è€ƒè™‘è§„èŒƒåŒ–ã€ç´¢å¼•ä¼˜åŒ–å’Œäº‹åŠ¡å¤„ç†ã€‚",
          },
          {
            id: "doc9",
            url: "https://example.com/devops",
            title: "DevOps å®è·µ",
            content: "DevOps æ˜¯å¼€å‘ï¼ˆDevelopmentï¼‰å’Œè¿ç»´ï¼ˆOperationsï¼‰çš„ç»“åˆï¼Œæ—¨åœ¨ç¼©çŸ­å¼€å‘å‘¨æœŸå¹¶æä¾›æŒç»­äº¤ä»˜ã€‚æ ¸å¿ƒå®è·µåŒ…æ‹¬æŒç»­é›†æˆï¼ˆCIï¼‰ã€æŒç»­éƒ¨ç½²ï¼ˆCDï¼‰ã€åŸºç¡€è®¾æ–½å³ä»£ç å’Œè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚å¸¸ç”¨å·¥å…·åŒ…æ‹¬ Dockerã€Kubernetesã€Jenkins å’Œ GitLab CI/CDã€‚ç›‘æ§å’Œæ—¥å¿—åˆ†æå¯¹äºç»´æŠ¤ç³»ç»Ÿç¨³å®šæ€§è‡³å…³é‡è¦ã€‚",
          },
          {
            id: "doc10",
            url: "https://example.com/nlp",
            title: "è‡ªç„¶è¯­è¨€å¤„ç†",
            content: "è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä¸“æ³¨äºè®¡ç®—æœºä¸äººç±»è¯­è¨€çš„äº¤äº’ã€‚åº”ç”¨åŒ…æ‹¬æœºå™¨ç¿»è¯‘ã€æƒ…æ„Ÿåˆ†æã€æ–‡æœ¬æ‘˜è¦å’ŒèŠå¤©æœºå™¨äººã€‚ç°ä»£ NLP æŠ€æœ¯åŸºäºæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œå¦‚ Transformerã€BERT å’Œ GPTã€‚è¯å‘é‡å’Œè¯­è¨€æ¨¡å‹æ˜¯ NLP çš„åŸºç¡€æŠ€æœ¯ï¼Œç”¨äºç†è§£å•è¯å’Œå¥å­çš„è¯­ä¹‰ã€‚",
          },
          {
            id: "doc11",
            url: "https://example.com/cv",
            title: "è®¡ç®—æœºè§†è§‰",
            content: "è®¡ç®—æœºè§†è§‰ä½¿è®¡ç®—æœºèƒ½å¤Ÿä»å›¾åƒå’Œè§†é¢‘ä¸­è·å–æœ‰æ„ä¹‰çš„ä¿¡æ¯ã€‚åº”ç”¨åŒ…æ‹¬äººè„¸è¯†åˆ«ã€ç‰©ä½“æ£€æµ‹ã€å›¾åƒåˆ†å‰²å’Œè‡ªåŠ¨é©¾é©¶ã€‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰æ˜¯è®¡ç®—æœºè§†è§‰çš„æ ¸å¿ƒæŠ€æœ¯ã€‚OpenCV æ˜¯ä¸€ä¸ªæµè¡Œçš„è®¡ç®—æœºè§†è§‰åº“ï¼Œæä¾›äº†ä¸°å¯Œçš„å›¾åƒå¤„ç†åŠŸèƒ½ã€‚å›¾åƒå¢å¼ºå’Œç‰¹å¾æå–æ˜¯é¢„å¤„ç†çš„é‡è¦æ­¥éª¤ã€‚",
          },
          {
            id: "doc12",
            url: "https://example.com/iot",
            title: "ç‰©è”ç½‘æŠ€æœ¯",
            content: "ç‰©è”ç½‘ï¼ˆIoTï¼‰è¿æ¥ç‰©ç†è®¾å¤‡åˆ°äº’è”ç½‘ï¼Œå®ç°æ•°æ®æ”¶é›†å’Œè¿œç¨‹æ§åˆ¶ã€‚æ™ºèƒ½å®¶å±…ã€å·¥ä¸šè‡ªåŠ¨åŒ–å’Œæ™ºæ…§åŸå¸‚æ˜¯ IoT çš„å…¸å‹åº”ç”¨ã€‚ç‰©è”ç½‘ç³»ç»ŸåŒ…æ‹¬ä¼ æ„Ÿå™¨ã€ç½‘å…³ã€äº‘å¹³å°å’Œåº”ç”¨ç¨‹åºã€‚å¸¸ç”¨çš„é€šä¿¡åè®®åŒ…æ‹¬ MQTTã€CoAP å’Œ LoRaWANã€‚è¾¹ç¼˜è®¡ç®—å¯ä»¥å‡å°‘å»¶è¿Ÿå¹¶æé«˜ IoT ç³»ç»Ÿçš„æ•ˆç‡ã€‚",
          },
          {
            id: "doc13",
            url: "https://example.com/testing",
            title: "è½¯ä»¶æµ‹è¯•æ–¹æ³•",
            content: "è½¯ä»¶æµ‹è¯•ç¡®ä¿åº”ç”¨ç¨‹åºçš„è´¨é‡å’Œå¯é æ€§ã€‚æµ‹è¯•ç±»å‹åŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç³»ç»Ÿæµ‹è¯•å’Œç”¨æˆ·éªŒæ”¶æµ‹è¯•ã€‚è‡ªåŠ¨åŒ–æµ‹è¯•ä½¿ç”¨å·¥å…·å¦‚ Seleniumã€Jest å’Œ Pytest æé«˜æµ‹è¯•æ•ˆç‡ã€‚æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰å’Œè¡Œä¸ºé©±åŠ¨å¼€å‘ï¼ˆBDDï¼‰æ˜¯æµè¡Œçš„æµ‹è¯•æ–¹æ³•è®ºã€‚ä»£ç è¦†ç›–ç‡å’Œç¼ºé™·è·Ÿè¸ªæ˜¯æµ‹è¯•ç®¡ç†çš„é‡è¦æŒ‡æ ‡ã€‚",
          },
          {
            id: "doc14",
            url: "https://example.com/design-patterns",
            title: "è®¾è®¡æ¨¡å¼ç²¾è§£",
            content: "è®¾è®¡æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡ä¸­å¸¸è§é—®é¢˜çš„å¯é‡ç”¨è§£å†³æ–¹æ¡ˆã€‚åˆ›å»ºå‹æ¨¡å¼åŒ…æ‹¬å•ä¾‹ã€å·¥å‚å’Œå»ºé€ è€…æ¨¡å¼ã€‚ç»“æ„å‹æ¨¡å¼å¦‚é€‚é…å™¨ã€è£…é¥°å™¨å’Œä»£ç†æ¨¡å¼ã€‚è¡Œä¸ºå‹æ¨¡å¼åŒ…æ‹¬è§‚å¯Ÿè€…ã€ç­–ç•¥å’Œå‘½ä»¤æ¨¡å¼ã€‚è®¾è®¡æ¨¡å¼æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¯è¯»æ€§ã€‚SOLID åŸåˆ™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„åŸºç¡€ã€‚",
          },
          {
            id: "doc15",
            url: "https://example.com/microservices",
            title: "å¾®æœåŠ¡æ¶æ„",
            content: "å¾®æœåŠ¡æ¶æ„å°†åº”ç”¨ç¨‹åºæ‹†åˆ†ä¸ºå°å‹ã€ç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£ç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½ã€‚æœåŠ¡ä¹‹é—´é€šè¿‡ API é€šä¿¡ï¼Œé€šå¸¸ä½¿ç”¨ REST æˆ– gRPCã€‚å¾®æœåŠ¡çš„ä¼˜åŠ¿åŒ…æ‹¬ç‹¬ç«‹éƒ¨ç½²ã€æŠ€æœ¯å¤šæ ·æ€§å’Œæ•…éšœéš”ç¦»ã€‚æœåŠ¡å‘ç°ã€API ç½‘å…³å’Œåˆ†å¸ƒå¼è¿½è¸ªæ˜¯å¾®æœåŠ¡æ¶æ„çš„å…³é”®ç»„ä»¶ã€‚å®¹å™¨åŒ–å’Œç¼–æ’å·¥å…·å¦‚ Docker å’Œ Kubernetes ç®€åŒ–äº†å¾®æœåŠ¡çš„éƒ¨ç½²ã€‚",
          },
        ];

        for (let i = 0; i < sampleDocs.length; i++) {
          const doc = sampleDocs[i];
          await indexer.indexDocument(doc.id, doc.url, doc.title, doc.content);
          updateProgress(60 + (i + 1) / sampleDocs.length * 30);
        }

        updateProgress(100);
        updateStatus("âœ“ åˆå§‹åŒ–å®Œæˆï¼å¯ä»¥å¼€å§‹æœç´¢", "success");
        addLog("âœ“ ç³»ç»Ÿå°±ç»ªï¼Œå¯ä»¥å¼€å§‹æœç´¢", "success");

        // è¿è¡ŒéªŒè¯æµ‹è¯•
        addLog("=== è¿è¡ŒéªŒè¯æµ‹è¯• ===", "info");
        await runValidationTests();

        document.getElementById("searchBtn").disabled = false;
        updateStats();
      } catch (error) {
        console.error("åˆå§‹åŒ–å¤±è´¥:", error);
        updateStatus(`âœ— åˆå§‹åŒ–å¤±è´¥: ${error.message}`, "error");
        addLog(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, "error");
      }
    }

    // æœç´¢
    async function search() {
      const query = document.getElementById("searchInput").value.trim();
      if (!query) {
        addLog("è¯·è¾“å…¥æœç´¢å†…å®¹", "warning");
        return;
      }

      if (!indexer || !indexer.isInitialized) {
        addLog("ç³»ç»Ÿå°šæœªåˆå§‹åŒ–å®Œæˆ", "warning");
        return;
      }

      try {
        updateStatus("æ­£åœ¨æœç´¢...", "loading");

        // è·å–ç›¸ä¼¼åº¦é˜ˆå€¼
        const thresholdSlider = document.getElementById("thresholdSlider");
        const threshold = parseInt(thresholdSlider.value) / 100;

        // è·å–æ›´å¤šç»“æœç”¨äºè¿‡æ»¤ï¼ˆç±»ä¼¼ mcp-chrome çš„åšæ³•ï¼‰
        const allResults = await indexer.search(query, 50);

        // è¿‡æ»¤ä½äºé˜ˆå€¼çš„ç»“æœ
        const filteredResults = allResults.filter(r => r.similarity >= threshold);

        // åªä¿ç•™å‰ 10 ä¸ª
        const topResults = filteredResults.slice(0, 10);

        addLog(`âœ“ æœç´¢å®Œæˆï¼šæ‰¾åˆ° ${allResults.length} ä¸ªç»“æœï¼Œè¿‡æ»¤å ${filteredResults.length} ä¸ªï¼ˆé˜ˆå€¼: ${(threshold * 100).toFixed(0)}%ï¼‰ï¼Œæ˜¾ç¤ºå‰ ${topResults.length} ä¸ª`, "success");

        displayResults(topResults);
        updateStatus(`âœ“ æ‰¾åˆ° ${topResults.length} ä¸ªç»“æœï¼ˆç›¸ä¼¼åº¦ â‰¥ ${(threshold * 100).toFixed(0)}%ï¼‰`, "success");
      } catch (error) {
        console.error("æœç´¢å¤±è´¥:", error);
        updateStatus(`âœ— æœç´¢å¤±è´¥: ${error.message}`, "error");
        addLog(`æœç´¢å¤±è´¥: ${error.message}`, "error");
      }
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById("searchBtn").addEventListener("click", search);
    document.getElementById("searchInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        search();
      }
    });

    document.getElementById("initBtn").addEventListener("click", async () => {
      const initBtn = document.getElementById("initBtn");
      const modelSelect = document.getElementById("modelSelect");

      // ç¦ç”¨æŒ‰é’®å’Œé€‰æ‹©å™¨
      initBtn.disabled = true;
      modelSelect.disabled = true;
      initBtn.textContent = "åˆå§‹åŒ–ä¸­...";

      await initialize();
    });

    // é¡µé¢åŠ è½½å®Œæˆ
    addLog("é¡µé¢åŠ è½½å®Œæˆ", "info");
    addLog("âœ“ ä½¿ç”¨ CDN ç‰ˆ transformers.js + WASM å‘é‡æ•°æ®åº“ï¼ˆé«˜æ€§èƒ½ï¼‰", "success");
    addLog("è¯·é€‰æ‹©æ¨¡å‹å¹¶ç‚¹å‡»ã€åˆå§‹åŒ–æœç´¢å¼•æ“ã€‘æŒ‰é’®", "info");
  </script>
</body>

</html>